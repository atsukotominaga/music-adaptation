---
title: 'Analysis for Non-Expressive performances (DURATION)'
output:
  html_notebook: default
editor_options: 
  chunk_output_type: inline
---

Description: This is a rough overview of non-expressive performance from teaching-v2.0 (duration).

```{r setup, include = FALSE}
# packages
# data manipulation
if (!require("data.table")) {install.packages("data.table"); require("data.table")}
# plot
if (!require("ggplot2")) {install.packages("ggplot2"); require("ggplot2")}

# ggplots
theme_set(theme_classic())
theme_update(text = element_text(size = 20, family = "Helvetica Neue LT Std 57 Condensed"), legend.position = "bottom")
```

```{r extract, include = FALSE}
# read a filtered csv
df_onset <- fread("./preprocessor/filtered/data_onset.csv", header = T, sep = ",", dec = ".")
df_offset <- fread("./preprocessor/filtered/data_offset.csv", header = T, sep = ",", dec = ".")

# SubNr as a factor
df_onset$SubNr <- as.factor(df_onset$SubNr)
df_offset$SubNr <- as.factor(df_offset$SubNr)

# assign RowNr
df_onset$RowNr <- rep(1:72, nrow(df_onset)/72)
df_offset$RowNr <- rep(1:72, nrow(df_offset)/72)
```

```{r normDus, include = FALSE}
# extract trials which have both onset and offset data
df_onset$Eval <- "NA"
for (subnr in unique(df_offset$SubNr)){
  for (trial in unique(df_offset[SubNr == subnr]$Trial)){
    df_onset[SubNr == subnr & TrialNr == trial]$Eval <- "Yes"
  }
}
df_duration <- df_onset[Eval == "Yes"]

# check whether each row corresponds correctly
df_duration$Eval2 <- "NA"
for (i in 1:nrow(df_duration)){
  if (df_duration[i]$SubNr == df_offset[i]$SubNr & df_duration[i]$TrialNr == df_offset[i]$TrialNr & df_duration[i]$Pitch == df_offset[i]$Pitch){
    df_duration[i]$Eval2 <- "SAME"
  } else {
    df_duration[i]$Eval2 <- "DIFF"
  }
}
print(unique(df_duration$Eval2))

# calculate duration
df_duration$Duration <- df_offset$TimeStamp - df_duration$TimeStamp

# convert bpm to ms
df_duration[Tempo == 120]$Tempo <- 250
df_duration[Tempo == 110]$Tempo <- 273
df_duration[Tempo == 100]$Tempo <- 300

# normalised Duration
df_duration$normDu <- df_duration$Duration/df_duration$Tempo

# remove irrelevant intervals
ls_irrelevant <- list(c(27:28), c(33:35), 52, 57, c(66:72))
df_duration$EighthNote <- "Yes"

for (phrase in 1:length(ls_irrelevant)){
  for (note in 1:length(ls_irrelevant[[phrase]])){
    df_duration[RowNr == ls_irrelevant[[phrase]][note]]$EighthNote <- "No"
  }
}
```

# Duration
## 1. All - individual
- Average normDu for each participant.

```{r duration, echo = FALSE}
# For each individual
duration <- df_duration[EighthNote == "Yes", .(N = length(normDu), Mean = mean(normDu), SD = sd(normDu)), by = .(SubNr)]
print(duration)
```

### Plot
#### Bar chart
- Error bars show SD of the mean
- A dashed line represents the ideal tempo

```{r duration_bar,  echo = FALSE}
p_duration <- ggplot(data = duration, aes(x = SubNr, y = Mean)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = Mean - SD, ymax = Mean + SD),
                width = .2, position = position_dodge(.9)) +
  labs(y = "Normalised Duration", subtitle = "Duration: Non-Expression")
p_duration
```

## Sequence plot
```{r seq, fig.width = 10, echo = FALSE}
# For each individual
duration_seq <- df_duration[EighthNote == "Yes", .(N = length(normDu), Mean = mean(normDu), SD = sd(normDu)), .(SubNr, RowNr)]

p_duration_seq <- ggplot(data = duration_seq, aes(x = RowNr, y = Mean, colour = SubNr)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = Mean - SD, ymax = Mean + SD), width=.2,
                position = position_dodge(.05)) + 
  labs(x = "RowNr", y = "Normalised Duration") + scale_x_continuous(breaks=seq(1,66,1))
p_duration_seq
```

## 2. All - group
- Average normDus for each condition.

```{r duration_all, echo = FALSE}
# Group mean
duration_all <- df_duration[EighthNote == "Yes", .(N = length(normDu), Mean = mean(normDu), SD = sd(normDu))]
print(duration_all)
```

## Exclude outlier participants
```{r outlier, echo = FALSE}
excluded_duration <- duration[Mean < mean(duration$Mean)+3*mean(duration$SD) & Mean > mean(duration$Mean)-3*mean(duration$SD)]
print(excluded_duration)
```

```{r export, include = FALSE}
# export df_duration
write.csv(df_duration, file = "./data_duration.csv", row.names = F)
```
