---
title: "Preprocessing: filtering"
output: html_notebook
---

```{r setup, include = FALSE}
# set chunk option
knitr::opts_chunk$set(echo = FALSE)

# set working directory
if (!require("here")) {install.packages("here"); require("here")}
here::i_am("filtering.Rmd")

# create a folder if not exists
if (!file.exists(here("filtered"))){
  dir.create(here("filtered"))
}

# read functions
source(here("function.R"))

# read a text file for ideal performance
dt_ideal <- read.table(here("ideal.txt"))
colnames(dt_ideal) <- "Pitch"
dt_ideal$RowNr <- 1:nrow(dt_ideal)
setcolorder(dt_ideal, c(2, 1))

# create a list of data file names
lf <- list.files(here("raw_data"), pattern = "txt")

# create raw_data - merge all data files into one
raw_data <- data.table()
for (i in 1:length(lf)){
  data_i <- fread(file.path(here("raw_data"), lf[i]), header = F, sep = " ", dec = ".")
  raw_data <- rbind(raw_data, data_i)
}

# add column namesls
colnames(raw_data) <- c("NoteNr", "TimeStamp", "Pitch", "Velocity", "Key_OnOff", "Device", "SubNr", "TrialNr", "Stimuli", "Session")

# clean raw_data
raw_data$NoteNr <- as.numeric(gsub(",", "", raw_data$NoteNr))
raw_data$Session <- gsub(";", "", raw_data$Session)

# sort by SubNr, TrialNr
raw_data <- raw_data[order(raw_data$SubNr, raw_data$TrialNr),]

# raw_data without metronome
dt_all <- raw_data[Pitch != 31 & Pitch != 34]

# onset and offset for experimental session
dt_onset <- dt_all[Key_OnOff == 1 & Session == "experiment"]
dt_offset <- dt_all[Key_OnOff == 0 & Session == "experiment"]
```

# Detect erroneous trials
Firstly, separate non-erroneous performances from erroneous performances.

1) Onset

```{r onset}
dt_error_onset <- checker(dt_onset, dt_ideal)

# mark imperfect performances
dt_onset$Error <- 0
for (error in 1:nrow(dt_error_onset)){
  dt_onset[SubNr == dt_error_onset$SubNr[error] & TrialNr == dt_error_onset$TrialNr[error]]$Error <- 1
}

dt_correct_onset_1 <- dt_onset[Error == 0]
dt_correct_onset_1$RowNr <- rep(1:72, nrow(dt_correct_onset_1)/72)
setcolorder(dt_correct_onset_1, c(12, 1:11))

# export csv
fwrite(dt_correct_onset_1, file = here("filtered", "dt_correct_onset_1.txt"))

# print the result
dt_error_onset

# add CorrectionNr column
dt_error_onset$CorrectionNr <- NA
```

2) Offset

```{r offset, echo = FALSE}
dt_error_offset <- checker(dt_offset, dt_ideal)

# mark imperfect performances
dt_offset$Error <- 0
for (error in 1:nrow(dt_error_offset)){
  dt_offset[SubNr == dt_error_offset$SubNr[error] & TrialNr == dt_error_offset$TrialNr[error]]$Error <- 1
}

dt_correct_offset_1 <- dt_offset[Error == 0]
dt_correct_offset_1$RowNr <- rep(1:72, nrow(dt_correct_offset_1)/72)
setcolorder(dt_correct_offset_1, c(12, 1:11))

# export csv
fwrite(dt_correct_offset_1, file = here("filtered", "dt_correct_offset_1.txt"))

# print the result
dt_error_offset

# add CorrectionNr column
dt_error_offset$CorrectionNr <- NA
```

# Manual pitch removal
Second, manually correct some pitch errors if the performance has only one type of the following errors:

- Extra notes
- Missing notes
- Substituted notes

## Extra notes
1) Onset

```{r extra-onset, include = FALSE, eval = FALSE}
error_extra_onset <- dt_error_onset[Reason == "Extra Notes"]
dt_correct_onset_2 <- data.table()
for (row in 1:nrow(error_extra_onset)){
  current <- dt_onset[SubNr == error_extra_onset$SubNr[row] & TrialNr == error_extra_onset$TrialNr[row]]
  decision = 2 
  correction = 0 # # of correction for reporting stats
  while (decision == 2){
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- First check -----")
    current <- edit(current, dt_ideal)
    print("----- Correction check -----")
    edit(current, dt_ideal)
    decision <- menu(c("y", "n", "other"), title = "Save the current data? (to continue, enter 'n')")
    if (decision == 1){
      correction = correction + 1
      error_extra_onset$CorrectionNr[row] <- correction
      dt_correct_onset_2 <- rbind(dt_correct_onset_2, current[, -c(5:6)])
    } else if (decision == 3){
      error_extra_onset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    } else if (decision == 2){
      correction = correction + 1
      print("----- Continue correction -----")
    }
  }
}

# export csv
fwrite(dt_correct_onset_2, file = here("filtered", "dt_correct_onset_2.txt"))
fwrite(error_extra_onset, file = here("filtered", "error_extra_onset.txt"))
```

```{r}
error_extra_onset <- fread(here("filtered/error_extra_onset.txt"))
error_extra_onset
```

2) Offset

```{r extra-offset, include = FALSE, eval = FALSE}
error_extra_offset <- dt_error_offset[Reason == "Extra Notes"]
dt_correct_offset_2 <- data.table()
for (row in 1:nrow(error_extra_offset)){
  current <- dt_offset[SubNr == error_extra_offset$SubNr[row] & TrialNr == error_extra_offset$TrialNr[row]]
  decision = 2 
  correction = 0 # # of correction for reporting stats
  while (decision == 2){
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- First check -----")
    current <- edit(current, dt_ideal)
    print("----- Correction check -----")
    edit(current, dt_ideal)
    decision <- menu(c("y", "n", "other"), title = "Save the current data? (to continue, enter 'n')")
    if (decision == 1){
      correction = correction + 1
      error_extra_offset$CorrectionNr[row] <- correction
      dt_correct_offset_2 <- rbind(dt_correct_offset_2, current[, -c(5:6)])
    } else if (decision == 3){
      error_extra_offset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    } else if (decision == 2){
      correction = correction + 1
      print("----- Continue correction -----")
    }
  }
}

# export csv
fwrite(dt_correct_offset_2, file = here("filtered", "dt_correct_offset_2.txt"))
fwrite(error_extra_offset, file = here("filtered", "error_extra_offset.txt"))
```

```{r}
error_extra_offset <- fread(here("filtered/error_extra_offset.txt"))
error_extra_offset
```

## Missing notes
1) Onset

```{r missing-onset, include = FALSE, eval = FALSE}
error_missing_onset <- dt_error_onset[Reason == "Missing Notes"]

dt_correct_onset_3 <- data.table()
for (row in 1:nrow(error_missing_onset)){
  current <- dt_onset[SubNr == error_missing_onset$SubNr[row] & TrialNr == error_missing_onset$TrialNr[row]]
  diff <- abs(nrow(dt_ideal) - nrow(current))
  if (diff < 5){
    # insert NA row
    current <- insert_na(current, dt_ideal)
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- Correction check -----")
    current <- edit(current, dt_ideal)
    decision <- menu(c("y", "other"), title = "Save the current data?")
    if (decision == 1){
      error_missing_onset$CorrectionNr[row] <- diff
      dt_correct_onset_3 <- rbind(dt_correct_onset_3, current[, -c(5:6)])
    } else if (decision == 2){
      error_missing_onset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    }
  } else {
    error_missing_onset$CorrectionNr[row] <- "Check individually"
  }
}

# export csv
fwrite(dt_correct_onset_3, file = here("filtered", "dt_correct_onset_3.txt"))
fwrite(error_missing_onset, file = here("filtered", "error_missing_onset.txt"))
```

```{r}
error_missing_onset <- fread(here("filtered/error_missing_onset.txt"))
error_missing_onset
```

2) Offset

```{r missing-offset, include = FALSE, eval = FALSE}
error_missing_offset <- dt_error_offset[Reason == "Missing Notes"]

dt_correct_offset_3 <- data.table()
for (row in 1:nrow(error_missing_offset)){
  current <- dt_offset[SubNr == error_missing_offset$SubNr[row] & TrialNr == error_missing_offset$TrialNr[row]]
  diff <- abs(nrow(dt_ideal) - nrow(current))
  if (diff < 5){
    # insert NA row
    current <- insert_na(current, dt_ideal)
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- Correction check -----")
    current <- edit(current, dt_ideal)
    decision <- menu(c("y", "other"), title = "Save the current data?")
    if (decision == 1){
      error_missing_offset$CorrectionNr[row] <- diff
      dt_correct_offset_3 <- rbind(dt_correct_offset_3, current[, -c(5:6)])
    } else if (decision == 2){
      error_missing_offset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    }
  } else {
    error_missing_offset$CorrectionNr[row] <- "Check individually"
  }
}

# export csv
fwrite(dt_correct_offset_3, file = here("filtered", "dt_correct_offset_3.txt"))
fwrite(error_missing_offset, file = here("filtered", "error_missing_offset.txt"))
```

```{r}
error_missing_offset <- fread(here("filtered/error_missing_offset.txt"))
error_missing_offset
```

## Substituted notes
1) Onset

```{r sub-onset, include = FALSE, eval = FALSE}
error_sub_onset <- dt_error_onset[startsWith(Reason, "Substituted")]

dt_correct_onset_4 <- data.table()
for (row in 1:nrow(error_sub_onset)){
  current <- dt_onset[SubNr == error_sub_onset$SubNr[row] & TrialNr == error_sub_onset$TrialNr[row]]
  decision = 2 
  correction = 0 # # of correction for reporting stats
  while (decision == 2){
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- First check -----")
    current <- edit(current, dt_ideal)
    print("----- Correction check -----")
    edit(current, dt_ideal)
    decision <- menu(c("y", "n", "other"), title = "Save the current data? (to continue, enter 'n')")
    if (decision == 1){
      correction = correction + 1
      error_sub_onset$CorrectionNr[row] <- correction
      dt_correct_onset_4 <- rbind(dt_correct_onset_4, current[, -c(5:6)])
    } else if (decision == 3) {
      error_sub_onset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    } else if (decision == 2){
      correction = correction + 1
      print("----- Continue correction -----")
    }
  }
}

# export csv
fwrite(dt_correct_onset_4, file = here("filtered", "dt_correct_onset_4.txt"))
fwrite(error_sub_onset, file = here("filtered", "error_sub_onset.txt"))
```

```{r}
error_sub_onset <- fread(here("filtered/error_sub_onset.txt"))
error_sub_onset
```

2) Offset

```{r sub-offset, include = FALSE, eval = FALSE}
error_sub_offset <- dt_error_offset[startsWith(Reason, "Substituted")]

dt_correct_offset_4 <- data.table()
for (row in 1:nrow(error_sub_offset)){
  current <- dt_offset[SubNr == error_sub_offset$SubNr[row] & TrialNr == error_sub_offset$TrialNr[row]]
  decision = 2 
  correction = 0 # # of correction for reporting stats
  while (decision == 2){
    print(sprintf("SubNr: %s, TrialNr: %s", unique(current$SubNr), unique(current$TrialNr)))
    print("----- First check -----")
    current <- edit(current, dt_ideal)
    print("----- Correction check -----")
    edit(current, dt_ideal)
    decision <- menu(c("y", "n", "other"), title = "Save the current data? (to continue, enter 'n')")
    if (decision == 1){
      correction = correction + 1
      error_sub_offset$CorrectionNr[row] <- correction
      dt_correct_offset_4 <- rbind(dt_correct_offset_4, current[, -c(5:6)])
    } else if (decision == 3) {
      error_sub_offset$CorrectionNr[row] <- readline(prompt = "Reason?: ")
    } else if (decision == 2){
      correction = correction + 1
      print("----- Continue correction -----")
    }
  }
}

# export csv
fwrite(dt_correct_offset_4, file = here("filtered", "dt_correct_offset_4.txt"))
fwrite(error_sub_offset, file = here("filtered", "error_sub_offset.txt"))
```

```{r}
error_sub_offset <- fread(here("filtered/error_sub_offset.txt"))
error_sub_offset
```

# Individual investigation
If the performance has complicated pitch errors, investigate individually.

1) Onset

```{r}
# combine error
error_onset <- rbind(error_extra_onset, error_missing_onset, error_sub_onset)

error_ind_onset <- error_onset[startsWith(CorrectionNr, "Check")]
error_ind_onset
```

1) SubNr: 12, TrialNr: 13

```{r, include = FALSE}
current_1 <- dt_onset[SubNr == error_ind_onset$SubNr[1] & TrialNr == error_ind_onset$TrialNr[1]]
current_1$RowNr <- c(1:nrow(current_1))
current_1$Ideal <- c(dt_ideal$Pitch, rep(NA, abs(nrow(current_1) - nrow(dt_ideal))))
graph(current_1)

# remove the first error
current_1 <- edit(current_1, dt_ideal)
current_1$Ideal <- dt_ideal$Pitch
graph(current_1)

# corrected the second error (substituted note)
current_1 <- edit(current_1, dt_ideal)
graph(current_1)

error_ind_onset$CorrectionNr[1] <- 2
```

2) SubNr: 10, TrialNr: 10

```{r, include = FALSE}
current_2 <- dt_onset[SubNr == error_ind_onset$SubNr[2] & TrialNr == error_ind_onset$TrialNr[2]]
current_2 <- insert_na(current_2, dt_ideal)
current_2$RowNr <- c(1:nrow(current_2))
current_2$Ideal <- dt_ideal$Pitch
graph(current_2)

# insert one skipped note
current_2 <- edit(current_2, dt_ideal)
current_2$Ideal <- dt_ideal$Pitch
current_2$RowNr <- 1:nrow(current_2)
graph(current_2)

# remove an extra note
current_2 <- edit(current_2, dt_ideal)
current_2$Ideal <- dt_ideal$Pitch
graph(current_2)

error_ind_onset$CorrectionNr[2] <- 3
```

3) SubNr

```{r, include = FALSE}
current_3 <- dt_onset[SubNr == error_ind_onset$SubNr[3] & TrialNr == error_ind_onset$TrialNr[3]]


```

2) Offset

```{r, include = FALSE}
# combine error
error_offset <- rbind(error_extra_offset, error_missing_offset, error_sub_offset)

error_ind_offset <- error_offset[startsWith(CorrectionNr, "Check")]
error_ind_offset
```
